# docker-compose.areal.yml
# AReaL GRPO 训练 Docker Compose 配置

version: '3.8'

services:
  # ============ vLLM 推理服务 ============
  vllm:
    image: vllm/vllm-openai:latest
    container_name: vllm-cua-areal
    
    # 使用所有 GPU（或指定部分 GPU 用于推理）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all  # 或指定数量
              capabilities: [gpu]
    
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface
      - ./outputs:/workspace/outputs
    
    environment:
      - HF_ENDPOINT=${HF_ENDPOINT:-https://hf-mirror.com}
      - VLLM_ALLOW_RUNTIME_LORA_UPDATING=True
    
    command: >
      --model ${MODEL_NAME:-Qwen/Qwen3-VL-32B-Instruct}
      --tensor-parallel-size ${TENSOR_PARALLEL_SIZE:-4}
      --max-model-len ${MAX_MODEL_LEN:-16384}
      --gpu-memory-utilization ${GPU_MEMORY_UTILIZATION:-0.85}
      --enable-lora
      --max-lora-rank 32
      --trust-remote-code
    
    ports:
      - "8000:8000"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    
    restart: unless-stopped

  # ============ AReaL 训练服务 ============
  trainer:
    build:
      context: .
      dockerfile: Dockerfile.areal
    
    container_name: areal-cua-trainer
    
    # 使用所有 GPU（让 FSDP 自动分配）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    volumes:
      - .:/workspace
      - ~/.cache/huggingface:/root/.cache/huggingface
      - ./outputs:/workspace/outputs
    
    environment:
      - GBOX_API_KEY=${GBOX_API_KEY}
      - HF_ENDPOINT=${HF_ENDPOINT:-https://hf-mirror.com}
      - HF_TOKEN=${HF_TOKEN:-}
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - VLLM_API_BASE=http://vllm:8000/v1
      - CONFIG_FILE=${CONFIG_FILE:-configs/cua_grpo.yaml}
      # 分布式训练环境变量（AReaL 会自动设置）
      - NCCL_DEBUG=INFO
    
    depends_on:
      vllm:
        condition: service_healthy
    
    command: >
      -m areal.launcher.local
      train_areal.py
      --config ${CONFIG_FILE:-configs/cua_grpo.yaml}
    
    restart: "no"
    
    # 允许共享内存（分布式训练需要）
    shm_size: '16gb'
    
    # 网络配置（分布式通信）
    ipc: host

